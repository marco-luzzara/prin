<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>BA-PHERD - {% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="{{ url_for('static', filename='utils.js') }}"></script>
</head>

<body class="mdc-typography flex m-[unset]">
    {% with errors = get_flashed_messages(category_filter=["error"]) %}
    {% if errors %}
    <div class="mdc-banner" id="errors-banner" role="banner">
        <div class="mdc-banner__fixed">
            <div class="mdc-banner__content" role="alertdialog" aria-live="assertive">
                <div class="mdc-banner__graphic-text-wrapper">
                    <div class="mdc-banner__text">
                        <ul>
                            {% for error in errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="mdc-banner__actions">
                    <button type="button" class="mdc-button mdc-banner__primary-action">
                        <div class="mdc-button__ripple"></div>
                        <div class="mdc-button__label">Contact admin</div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endwith %}

    {% with messages = get_flashed_messages(category_filter=["action_success"]) %}
    {% if messages %}
    <aside class="mdc-snackbar" id="notification-snackbar">
        <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
            <div class="mdc-snackbar__label" aria-atomic="false">
                <ul>
                    {% for msg in messages %}
                    <li>
                        {{ msg }}
                        <span class="material-icons text-[green]">check_circle</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="mdc-snackbar__actions" aria-atomic="true">
                <button type="button" class="mdc-button mdc-snackbar__action">
                    <div class="mdc-button__ripple"></div>
                    <span class="mdc-button__label">Ok</span>
                </button>
            </div>
        </div>
    </aside>
    {% endif %}
    {% endwith %}

    <div class="mdc-dialog" id="login-dialog">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface" role="dialog" aria-modal="true" aria-labelledby="login-dialog-title"
                aria-describedby="login-dialog-content">
                <form method="post" action="{{ url_for('users.login') }}">
                    <h2 class="mdc-dialog__title" id="login-dialog-title">User Login</h2>
                    <div class="mdc-dialog__content" style="overflow: unset;">
                        <div id="login-dialog-content" class="flex flex-col justify-center items-center">
                            <div id="login-group-select"
                                class="mdc-select mdc-select--filled mdc-select--required prin-login-dialog__field">
                                <input type="hidden" name="group">
                                <div class="mdc-select__anchor" role="button" aria-haspopup="listbox"
                                    aria-required="true" aria-expanded="false">
                                    <span class="mdc-select__ripple"></span>
                                    <span class="mdc-floating-label">Gruppo</span>
                                    <span class="mdc-select__selected-text-container">
                                        <span class="mdc-select__selected-text"></span>
                                    </span>
                                    <span class="mdc-select__dropdown-icon">
                                        <svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5"
                                            focusable="false">
                                            <polygon class="mdc-select__dropdown-icon-inactive" stroke="none"
                                                fill-rule="evenodd" points="7 10 12 15 17 10">
                                            </polygon>
                                            <polygon class="mdc-select__dropdown-icon-active" stroke="none"
                                                fill-rule="evenodd" points="7 15 12 10 17 15">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <span class="mdc-line-ripple"></span>
                                </div>
                                <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                    <ul class="mdc-list" role="listbox" aria-label="Groups list">
                                        <li class="mdc-list-item mdc-list-item--selected" aria-selected="true"
                                            data-value="" role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="test-group1"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">
                                                test-group1
                                            </span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="test-group2"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">
                                                test-group2
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div id="login-user-select"
                                class="mdc-select mdc-select--filled mdc-select--required mdc-select--disabled prin-login-dialog__field">
                                <input type="hidden" name="user" disabled="true" />
                                <div class=" mdc-select__anchor" role="button" aria-haspopup="listbox"
                                    aria-required="true" aria-expanded="false" aria-disabled="true">
                                    <span class="mdc-select__ripple"></span>
                                    <span class="mdc-floating-label">Utente</span>
                                    <span class="mdc-select__selected-text-container">
                                        <span class="mdc-select__selected-text"></span>
                                    </span>
                                    <span class="mdc-select__dropdown-icon">
                                        <svg class="mdc-select__dropdown-icon-graphic" viewBox="7 10 10 5"
                                            focusable="false">
                                            <polygon class="mdc-select__dropdown-icon-inactive" stroke="none"
                                                fill-rule="evenodd" points="7 10 12 15 17 10">
                                            </polygon>
                                            <polygon class="mdc-select__dropdown-icon-active" stroke="none"
                                                fill-rule="evenodd" points="7 15 12 10 17 15">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <span class="mdc-line-ripple"></span>
                                </div>
                                <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                    <ul class="mdc-list" role="listbox" aria-label="Users list">
                                        <li class="mdc-list-item mdc-list-item--selected" aria-selected="true"
                                            data-value="" role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="specialistdoc_user1"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">specialistdoc_user1</span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="specialistdoc_user2"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">specialistdoc_user2</span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="researcher_user1"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">researcher_user1</span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="researcher_user2"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">researcher_user2</span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="careworker_user1"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">careworker_user1</span>
                                        </li>
                                        <li class="mdc-list-item" aria-selected="false" data-value="careworker_user2"
                                            role="option">
                                            <span class="mdc-list-item__ripple"></span>
                                            <span class="mdc-list-item__text">careworker_user2</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mdc-dialog__actions">
                        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                            <div class="mdc-button__ripple"></div>
                            <span class="mdc-button__label">Cancel</span>
                        </button>
                        <button type="submit" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="accept"
                            data-mdc-dialog-button-default>
                            <div class="mdc-button__ripple"></div>
                            <span class="mdc-button__label">Login</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>

    <aside class="mdc-drawer pt-6" id="side-nav-bar">
        <div class="mdc-drawer__header">
            <div id="side-nav-bar-header" class="flex flex-col justify-center items-center">
                <img class="w-40" src="{{ url_for('static', filename='images/user-account.png') }}" alt="anonymous" />
                {% if session.user %}
                <h3 class="mdc-drawer__title">{{ session.user }}</h3>
                <h6 class="mdc-drawer__subtitle">Group: {{ session.group }}</h6>
                {% else %}
                <h3 class="mdc-drawer__title">Anonymous User</h3>
                {% endif %}
                <form method="post" action="{{ url_for('users.logout') }}">
                    <button
                        class="mdc-button mdc-button--raised mt-5 {% if session.user is undefined %}hidden!{% endif %}"
                        id="logout-button" type="submit">
                        <span class="mdc-button__ripple"></span>
                        <span class="mdc-button__label">Logout</span>
                    </button>
                </form>
                <button class="mdc-button mdc-button--raised mt-5 {% if session.user %}hidden!{% endif %}"
                    id="login-button">
                    <span class="mdc-button__ripple"></span>
                    <span class="mdc-button__label">Login</span>
                </button>
            </div>
        </div>
        <div class="mdc-drawer__content">
            <nav class="mdc-list">
                <hr class="mdc-list-divider">
                <a class="mdc-list-item {{ 'mdc-list-item--activated' if request.endpoint == 'homepage' }}"
                    href="{{ url_for('homepage') }}">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">home</i>
                    <span class="mdc-list-item__text">Home</span>
                </a>
                <a class="mdc-list-item {{ 'mdc-list-item--activated' if request.endpoint == 'patients-data-loading.view_data_loading_dashboard' }}"
                    href="{{ url_for('patients-data-loading.view_data_loading_dashboard') }}">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">groups</i>
                    <span class="mdc-list-item__text">Pazienti</span>
                </a>
                <a class="mdc-list-item {{ 'mdc-list-item--activated' if request.endpoint == 'mir-results-data-loading.view_data_loading_dashboard' }}"
                    href="{{ url_for('mir-results-data-loading.view_data_loading_dashboard') }}">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">biotech</i>
                    <span class="mdc-list-item__text">Risultati MiRNA</span>
                </a>
                <a class="mdc-list-item {{ 'mdc-list-item--activated' if request.endpoint == 'task-runner.view_task_runner_dashboard' }}"
                    href="{{ url_for('task-runner.view_task_runner_dashboard') }}">
                    <span class="mdc-list-item__ripple"></span>
                    <i class="material-icons mdc-list-item__graphic" aria-hidden="true">construction</i>
                    <span class="mdc-list-item__text">Tasks</span>
                </a>
            </nav>
        </div>
    </aside>
    <div class="mdc-drawer-app-content mdc-theme--background page-container">
        <header class="mdc-top-app-bar mdc-top-app-bar--fixed" id="top-app-bar">
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                    <!-- <button class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button">menu</button> -->
                    <span class="mdc-top-app-bar__title">BA-PHERD</span>
                </section>
            </div>
        </header>
        <main class="main-content mdc-top-app-bar--fixed-adjust" id="main-content">
            <div class="mdc-top-app-bar--fixed-adjust">
                {% block main_content %}{% endblock %}
            </div>
        </main>
        <footer class="bg-(--mdc-theme-primary)">
            <div class="mdc-layout-grid">
                <div class="mdc-layout-grid__inner">
                    <div class="mdc-layout-grid__cell">
                        <img src="{{ url_for('static', filename='logos/italiadomani.png') }}" class="prin-footer__logo">
                    </div>
                    <div class="mdc-layout-grid__cell">
                        <img src="{{ url_for('static', filename='logos/MUR.png') }}" class="prin-footer__logo">
                    </div>
                    <div class="mdc-layout-grid__cell">
                        <img src="{{ url_for('static', filename='logos/NextGenerationEU.png') }}"
                            class="prin-footer__logo">
                    </div>
                </div>
            </div>
        </footer>
    </div>

    {% block js %}{% endblock %}

    <script type="module">
        // **MATERIAL DESIGN**

        // ** INITIALIZATION **
        // select
        // document.querySelectorAll('.mdc-select').forEach(el => {
        //     new mdc.select.MDCSelect(el);
        // });

        // snackbar
        const notificationSnackBar = document.getElementById('notification-snackbar');
        if (notificationSnackBar !== null) {
            const notificationSnackBarMDC = new mdc.snackbar.MDCSnackbar(notificationSnackBar);
            notificationSnackBarMDC.open();
        }

        // banner
        const errorsBanner = document.getElementById('errors-banner');
        if (errorsBanner !== null)
            (new mdc.banner.MDCBanner(errorsBanner)).open();

        // top app bar
        const topAppBar = new mdc.topAppBar.MDCTopAppBar(document.getElementById('top-app-bar'));

        // buttons
        document.querySelectorAll('.mdc-button').forEach(el => {
            new mdc.ripple.MDCRipple(el);
        });

        // list
        const drawerListElem = document.querySelector('#side-nav-bar .mdc-list')
        const drawerList = new mdc.list.MDCList(drawerListElem);
        document.querySelectorAll('.mdc-list-item').forEach(el => {
            new mdc.ripple.MDCRipple(el);
        });

        // text fields
        document.querySelectorAll('.mdc-text-field').forEach(el => {
            new mdc.textField.MDCTextField(el);
        });

        // dialogs
        const loginDialog = new mdc.dialog.MDCDialog(document.getElementById('login-dialog'));

        // ** END INITIALIZATION **

        // ** LOGIN **
        const loginGroupSelect = new mdc.select.MDCSelect(document.getElementById('login-group-select'));
        const loginUserSelect = new mdc.select.MDCSelect(document.getElementById('login-user-select'));
        loginDialog.listen('MDCDialog:opened', () => {
            loginGroupSelect.layout();
            loginUserSelect.layout();
        });

        const groupToUsersMap = new Map([
            ['test-group1', ['specialistdoc_user1', 'researcher_user1', 'careworker_user1']],
            ['test-group2', ['specialistdoc_user2', 'researcher_user2', 'careworker_user2']]
        ])

        loginGroupSelect.listen('MDCSelect:change', function () {
            loginUserSelect.setValue("");
            document.querySelectorAll('#login-user-select .mdc-list > li:not(:first-child)').forEach(el => {
                el.style.display = 'none';
            });

            const usersToEnable = groupToUsersMap.get(loginGroupSelect.value)
            usersToEnable.forEach(user => {
                document.querySelector(`#login-user-select .mdc-list > li[data-value="${user}"]`)
                    ?.style.setProperty('display', 'block');
            });

            loginUserSelect.disabled = false;
        })

        // drawer
        drawerList.wrapFocus = true;
        topAppBar.setScrollTarget(document.getElementById('main-content'));

        const mainContent = document.querySelector('.main-content');
        drawerListElem.addEventListener('click', (event) => {
            mainContent.querySelector('input, button, a').focus();
        });

        document.querySelector('#login-button').addEventListener('click', e => {
            loginDialog.open();
        })
    </script>
    {% block custom_js %}{% endblock %}
</body>

</html>